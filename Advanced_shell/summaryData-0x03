#!/usr/bin/env bash
# Advanced_shell / summaryData-0x03
# Generate a CSV report summarizing data for multiple Pokémon
# Use sed for capitalization and awk for calculating averages

set -Eeuo pipefail

# Folder where Pokémon data is stored (from Task 2)
INPUT_DIR="pokemon_data"
OUTPUT_CSV="pokemon_report.csv"

# Create CSV file with headers
echo "Name,Height (m),Weight (kg)" > "$OUTPUT_CSV"

# Initialize variable for calculating the average using awk
pokemon_count=0

# Loop through all JSON files in the pokemon_data directory
for json_file in "$INPUT_DIR"/*.json; do
  # Extract the name, height, and weight for each Pokémon using jq
  name=$(jq -r '.name' "$json_file" | sed 's/\b\(.\)/\U\1/g')
  height=$(jq -r '.height' "$json_file" | awk '{printf "%.1f", $1/10}')
  weight=$(jq -r '.weight' "$json_file" | awk '{printf "%.1f", $1/10}')

  # Append the data to the CSV file
  echo "$name,$height,$weight" >> "$OUTPUT_CSV"

  # Update the total counts for averages (using awk)
  echo "$height $weight" >> temp_heights_weights.txt
  pokemon_count=$((pokemon_count + 1))
done

# Calculate averages using awk
average_height=$(awk '{sum_h+=$1} END {if (NR > 0) print sum_h/NR}' temp_heights_weights.txt)
average_weight=$(awk '{sum_w+=$2} END {if (NR > 0) print sum_w/NR}' temp_heights_weights.txt)

# Append the averages to the CSV file
echo >> "$OUTPUT_CSV"
echo "Average Height: $average_height m" >> "$OUTPUT_CSV"
echo "Average Weight: $average_weight kg" >> "$OUTPUT_CSV"

# Clean up
rm -f temp_heights_weights.txt

# Output message
echo "CSV Report generated at: $OUTPUT_CSV"
